<form version="1.1" theme="light" stylesheet="scheduled-jobs-tracker.css">
  <label>ðŸ•’ Scheduled Jobs Tracker</label>
  <description>Tracking scheduled jobs</description>

  <!-- Base searches remain the same -->
  <search id="base_internal_scheduler_search">
    <query>index=_internal sourcetype=scheduler status="success" savedsearch_name=$title$ user=$owner$ | table _time savedsearch_name user status alert_actions app component event_message scheduled_time</query>
    <earliest>$time_tok.earliest$</earliest>
    <latest>$time_tok.latest$</latest>
  </search>

  <search id="base_rest_saved_searches_search">
    <query>| rest splunk_server=local /servicesNS/-/-/saved/searches 
| search is_scheduled=1 disabled=0 eai:acl.owner=$owner$ title=$title$
| fields dispatch.earliest_time dispatch.latest_time eai:acl.owner eai:acl.sharing search cron_schedule title eai:acl.app
| rename dispatch.earliest_time as earliest_time, dispatch.latest_time as latest_time, eai:acl.owner as owner, eai:acl.sharing as permission, eai:acl.app as app
| table title app cron_schedule earliest_time latest_time owner permission</query>
    <earliest>$time_tok.earliest$</earliest>
    <latest>$time_tok.latest$</latest>
  </search>

  <!-- Filters -->
  <fieldset submitButton="false">
    <input type="time" token="time_tok" searchWhenChanged="true">
      <label>Time</label>
      <default>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="text" token="title" searchWhenChanged="true">
      <label>title</label>
      <default>*</default>
      <prefix>"</prefix>
      <suffix>"</suffix>
      <initialValue>*</initialValue>
    </input>
    <input type="multiselect" token="owner" searchWhenChanged="true">
      <label>owner</label>
      <choice value="*">all</choice>
      <default>*</default>
      <prefix> </prefix>
      <valuePrefix>"</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <delimiter> OR </delimiter>
      <fieldForLabel>eai:acl.owner</fieldForLabel>
      <fieldForValue>eai:acl.owner</fieldForValue>
      <search>
        <query>| rest splunk_server=local /servicesNS/-/-/saved/searches 
| search is_scheduled=1 disabled=0 
| stats count by eai:acl.owner</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
    </input>
  </fieldset>

  <!-- Row 1: Trend and Sum -->
  <row>
    <panel>
      <html>
        <h2 class="trend-title">ðŸ“ˆ Trend of Alerts Triggered</h2>
      </html>
      <chart>
        <search base="base_internal_scheduler_search">
          <query>| timechart span=1d count by savedsearch_name useother=f</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.lineWidth">2</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.chart.style">shiny</option>
        <option name="trellis.enabled">0</option>
      </chart>
    </panel>

    <panel>
      <html>
        <h2 class="total-title">âœ… Sum of Alerts Triggered</h2>
      </html>
      <single>
        <search base="base_internal_scheduler_search">
          <query>| stats count by savedsearch_name | stats sum(count) as fired_alerts</query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: Top Alerts -->
  <row>
    <panel>
      <html>
        <h2 class="alerts-title">ðŸš¨ Top 10 Alerts</h2>
      </html>
      <table>
        <search base="base_internal_scheduler_search">
          <query>| stats latest(_time) as Latest count by savedsearch_name 
| convert ctime(Latest) as latest 
| fields latest savedsearch_name count 
| head 10</query>
        </search>
        <option name="count">10</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
      </table>
    </panel>
  </row>

  <!-- Row 3: Saved Searches -->
  <row>
    <panel>
      <html>
        <h2 class="savedsearches-title">ðŸ“‹ All Enabled Saved Searches</h2>
      </html>
      <table>
        <search base="base_rest_saved_searches_search">
          <query>| sort - cron_schedule | head 20</query>
        </search>
        <option name="count">20</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
</form>