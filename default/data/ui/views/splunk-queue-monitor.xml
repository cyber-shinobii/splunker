<form version="1.1" theme="dark" stylesheet="splunk-queue-monitor.css">
  <label>ðŸ“Š Splunk Queue Monitor</label>
  <description>Monitor the health of all Splunk ingestion queues using internal metrics. Use filters to drill down by host and queue name.</description>
  <search id="base_queue_metrics_search">
    <query>
      index=_internal sourcetype=splunkd component=Metrics group=queue name=* $host_tok$ $queue_tok$ | fields *
    </query>
    <earliest>$time_tok.earliest$</earliest>
    <latest>$time_tok.latest$</latest>
  </search>
  <fieldset submitButton="false">
    <input type="time" token="time_tok" searchWhenChanged="true">
      <label>Time Range</label>
      <default>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="multiselect" token="host_tok" searchWhenChanged="true">
      <label>Host</label>
      <default>*</default>
      <prefix>host IN (</prefix>
      <choice value="*">all</choice>
      <suffix>)</suffix>
      <initialValue>*</initialValue>
      <valuePrefix>"</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <delimiter>, </delimiter>
      <fieldForLabel>host</fieldForLabel>
      <fieldForValue>host</fieldForValue>
      <search base="base_queue_metrics_search">
        <query>| stats count by host</query>
      </search>
    </input>
    <input type="multiselect" token="queue_tok" searchWhenChanged="true">
      <label>Queue(s)</label>
      <delimiter>, </delimiter>
      <fieldForLabel>name</fieldForLabel>
      <fieldForValue>name</fieldForValue>
      <search base="base_queue_metrics_search">
        <query>| stats count by name</query>
      </search>
      <choice value="*">all</choice>
      <default>*</default>
      <initialValue>*</initialValue>
      <prefix>name IN (</prefix>
      <suffix>)</suffix>
      <valuePrefix>"</valuePrefix>
      <valueSuffix>"</valueSuffix>
    </input>
    <input type="dropdown" token="span_tok" searchWhenChanged="true">
      <label>span</label>
      <choice value="1m">1m</choice>
      <choice value="5m">5m</choice>
      <choice value="15m">15m</choice>
      <choice value="1h">1h</choice>
      <choice value="4h">4h</choice>
      <choice value="1d">1d</choice>
      <default>1d</default>
      <prefix>"</prefix>
      <suffix>"</suffix>
      <initialValue>1d</initialValue>
    </input>
  </fieldset>
  <row>
    <panel>
      <html>
        <h2 class="custom-panel-title">ðŸ“ˆ Queue Sizes Over Time</h2>
      </html>
      <chart>
        <search base="base_queue_metrics_search">
          <query>| timechart span=$span_tok$ max(current_size) by name useother=false usenull=false </query>
        </search>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleX.visibility">collapsed</option>
        <option name="charting.axisTitleY.text">Queue Size</option>
        <option name="charting.axisTitleY.visibility">collapsed</option>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">all</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <h2 class="custom-panel-title">ðŸ“Š Queue Utilization Overview (Event Count &amp; Size)</h2>
      </html>
      <table>
        <search base="base_queue_metrics_search">
          <query>| stats latest(current_size) as current_size latest(max_size) as max_size latest(current_size_kb) as current_size_kb latest(max_size_kb) as max_size_kb by name
| eval perc_used_size = round((current_size / max_size) * 100, 2)
| eval perc_used_kb = round((current_size_kb / max_size_kb) * 100, 2)
| table name current_size max_size current_size_kb max_size_kb perc_used_size perc_used_kb
| sort - current_size
          </query>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">highlow</option>
        <option name="drilldown">row</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">true</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <h2 class="custom-panel-title">ðŸ§­ Current Queue Size Snapshot</h2>
      </html>
      <table>
        <search base="base_queue_metrics_search">
          <query>| stats latest(current_size) as latest_size by name
| sort -latest_size</query>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">highlow</option>
        <option name="drilldown">row</option>
        <option name="percentagesRow">false</option>
        <option name="totalsRow">true</option>
      </table>
    </panel>
  </row>
</form>